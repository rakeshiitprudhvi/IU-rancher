{{- $dot := . }}
{{ if $dot.Values.appviewx.create -}}
{{- range .Values.appviewx.appname }}
{{- $appname_port_version := split ":" . }}
{{- range $key, $value := $dot.Values.common.namespace }}
---
apiVersion: autoscaling/v2beta1
kind: HorizontalPodAutoscaler
metadata:
  name: {{ $appname_port_version._0 }}-request
  namespace: {{ $value }}
  annotations:
    metric-config.object.istio-requests-total.prometheus/per-replica: "true"
    metric-config.object.istio-requests-total.prometheus/query: |
      sum(
        rate(
          istio_requests_total{
            response_code=~"502|503",
            destination_service="avx-vendors.{{ $value }}.svc.cluster.local"
          }[1m]
        )
      ) /
      count(
        count(
          container_memory_usage_bytes{
            namespace="{{ $value }}",
            pod=~"avx-vendors.*"
          }
        ) by (pod)
      )
spec:
  maxReplicas: {{ $dot.Values.circuitbreaking.maxreplica }}
  minReplicas: 1
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: {{ $appname_port_version._0 }}
  metrics:
    - type: Object
      object:
        metricName: istio-requests-total
        target:
          apiVersion: v1
          kind: Pod
          name: {{ $appname_port_version._0 }}
        targetValue: 0.2

{{- end }}
{{- end }}
{{ end -}}        
