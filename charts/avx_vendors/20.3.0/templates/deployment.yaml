{{- define "helm-toolkit.utils.joinListWithComma" -}}
{{- $local := dict "first" true -}}
{{- range $k, $v := . -}}{{- if not $local.first -}}:{{- end -}}{{-  printf "/appviewx/%s/%s/%s.jar" (split ":" $v)._0 (split ":" $v)._1 (split ":" $v)._0 -}}{{- $_ := set $local "first" false -}}{{- end -}}
{{- end -}}

{{- $dot := . }}
{{ if $dot.Values.appviewx.create -}}
{{- range .Values.appviewx.appname }}
{{- $appname_port_version := split ":" . }}
{{- range $key, $value := $dot.Values.common.namespace }}
---
apiVersion: v1
kind: Service
metadata:
  labels:
    app: {{ $appname_port_version._0 }}
  name: {{ $appname_port_version._0 }}
  namespace: {{ $value }}
spec:
  ports:
  - port: {{ $appname_port_version._1 }}
    protocol: TCP
    targetPort: {{ $appname_port_version._2 }}
  selector:
    app: {{ $appname_port_version._0 }}
  type: {{ $appname_port_version._3 }}
---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: {{ $appname_port_version._0 }}
  name: {{ $appname_port_version._0 }}
  namespace: {{ $value }}
spec:
  replicas: {{$dot.Values.appviewx.replicas}}
  selector:
    matchLabels:
      app: {{ $appname_port_version._0 }}
  template:
    metadata:
      labels:
        app: {{ $appname_port_version._0 }}
        version: {{ $appname_port_version._4  | replace "." "-"  }}
      annotations:
        timestamp: "{{ $dot.Values.timestamp }}"
        traffic.sidecar.istio.io/includeOutboundIPRanges: "10.96.0.0/12,10.244.0.0/16"
        prometheus.io/path: "{{$dot.Values.health.path}}"
        prometheus.io/port: "{{$dot.Values.health.port}}"
        prometheus.io/scrape: "{{$dot.Values.health.scrape}}"
    spec:
      volumes:
      - name: logs-pv-storage
        persistentVolumeClaim:
          claimName: logs-pv-claim
      - name: avx-properties-path
        configMap:
          name: {{ $dot.Values.common.config }}
          items:
          - key: appviewx.properties
            path: appviewx.properties
      containers:
      - image: {{ $dot.Values.image.registry }}/{{ $dot.Values.image.repository }}:{{ $dot.Values.image.tag }}  
        imagePullPolicy: Always
        envFrom:
        # The ConfigMap we want to use
        - configMapRef:
            name: {{ $dot.Values.common.config }}
        - configMapRef:
            name: {{ $dot.Values.appviewx.moduleconfig }}
        name: {{ $appname_port_version._0 }}
        command: ["/bin/bash","-c"]
        args: [" {{ if eq $dot.Values.externaljar.f5JarRequired "true" }}
                 {{$dot.Values.externaljar.iControlDownloadCommand}}
                 {{ end }}
                source /appviewx/dependencies/properties/hsm \
                && useradd -u {{ $dot.Values.appviewx.installation_user_id }} {{ $dot.Values.appviewx.installation_user }} \
                && chown -R {{ $dot.Values.appviewx.installation_user }}:{{ $dot.Values.appviewx.installation_user }} /usr/lib/jvm \
                && chown -R {{ $dot.Values.appviewx.installation_user }}:{{ $dot.Values.appviewx.installation_user }} /etc/pki/ca-trust/extracted/java \         
                && chown -R {{ $dot.Values.appviewx.installation_user }}:{{ $dot.Values.appviewx.installation_user }} /etc/pki/java/ \
                && chmod 777 /etc/pki/ca-trust/extracted/java/cacerts  \
                && chmod -R 777 ${DEPENDENCY_PATH}/logs/ \
                && su  {{ $dot.Values.appviewx.installation_user }} -s /bin/bash -c \"source /appviewx/dependencies/properties/hsm && java -Xms256m -Xmx2g \
                  -cp {{ include "helm-toolkit.utils.joinListWithComma" $dot.Values.appviewx.appviewx_plugins }}:/appviewx/{{ $appname_port_version._0 | replace "-" "_" }}/{{ $appname_port_version._0 | replace "-" "_" }}.jar:${DEPENDENCY_PATH}/properties \
                      -Davx_property_file_path=${DEPENDENCY_PATH}/properties/appviewx.properties \
                      -Dlog4j.configurationFile=${DEPENDENCY_PATH}/properties/log4j2.xml \
                      -DpluginName={{ $appname_port_version._0 | replace "-" "_" }} \
                      -Dlogfilename=${DEPENDENCY_PATH}/logs/ \
                      -DIP_ADDRESS=${IP_ADDRESS} \
                      -DSLA-STRATEGY=memory \
                      -Davx_logs_home=${DEPENDENCY_PATH}/logs/ \
                      -Dappviewx.property.path=${DEPENDENCY_PATH}/properties/ \
                      -DMONGO_ENCRYPTED_PASSWORD=${MONGO_ENCRYPTED_PASSWORD} \
                      -DMONGO_KEY=${MONGO_KEY} \
                      -DAPS_MONGO_ENCRYPTED_PASSWORD=${APS_MONGO_ENCRYPTED_PASSWORD} \
                      -DCONFIG_DOWNLOAD_PATH=${DEPENDENCY_PATH} \
                      -Dtrust_all_cert=true \
                      -Davx_installation_path=/appviewx/ \
                      -Dcom.sun.jndi.ldap.object.disableEndpointIdentification=true \
                      -DKAFKA_URL=${KAFKA_URL} \
                      -Djava.library.path=/appviewx/hsm/usr/gemalto_dpod/safenet/lunaclient/jcprov/lib/ \
                      -Davx_pkcs11_library_path=/appviewx/hsm/opt/cloudhsm/lib/libcloudhsm_pkcs11.so \
                      -DSKIP_APPSETTINGS_INIT_VALIDATION=true \
                      -Dport=8021 -DGW_REF_TIMEOUT:60000 \
                      -Davx_python_bin_path=${DEPENDENCY_PATH}/appviewx_addons/Python/bin/ \
                      -Dpython.cachedir.skip=true -Dpython.security.respectJavaAccessibility=false ${JAVA_AGENT_PATH} \
                      -Ddatacenter=${DATA_CENTER} \
                      -Djava.ext.dirs=/appviewx/dependencies/external_libs:/usr/lib/jvm/jre/lib/ext:/appviewx/dependencies/appviewx_addons/lib/common-libraries:/appviewx/dependencies/appviewx_addons/lib/runtime:/appviewx/dependencies/appviewx_addons/lib/others:/appviewx/dependencies/appviewx_addons/lib/config_client \
                      com.appviewx.common.framework.jetty.Main >> ${DEPENDENCY_PATH}/logs/{{ $appname_port_version._0 | replace "-" "_" }}-start.log\"
                      "]

        readinessProbe:
          httpGet:
            path: {{ $dot.Values.probe.path }}
            port: {{ $dot.Values.probe.port }}
          initialDelaySeconds: {{ $dot.Values.probe.initialDelaySeconds }}
          timeoutSeconds: {{ $dot.Values.probe.timeoutSeconds }}
          periodSeconds: {{ $dot.Values.probe.periodSeconds }}              
        resources:
          requests:
            memory: {{ $dot.Values.appviewx.memoryRequest }}
            {{- if eq $dot.Values.appviewx.multi "true" }} 
            cpu: {{ $dot.Values.appviewx.cpuRequest }}
            {{- end }}            
        volumeMounts:
        - mountPath: "{{ $dot.Values.appviewx.mountpath }}/logs"
          name: logs-pv-storage
        - name: avx-properties-path
          mountPath: /appviewx/dependencies/properties/appviewx.properties
          subPath: appviewx.properties
        securityContext:
          privileged: true  
        lifecycle:
            preStop:
              exec:
                command:
                  - /bin/sh
                  - '-c'
                  - sh /appviewx/dependencies/properties/stophandler.sh 
        env:
        - name: IP_ADDRESS
          valueFrom:
            fieldRef:
              apiVersion: v1
              fieldPath: status.hostIP
        - name: NODE_IP
          valueFrom:
            fieldRef:
              apiVersion: v1
              fieldPath: status.hostIP
      restartPolicy: Always
      terminationGracePeriodSeconds: 4800

{{- end }}
{{- end }}
{{ end -}}
